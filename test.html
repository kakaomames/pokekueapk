<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gemini programmingéšŠ - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ WebSocketã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ">
    <meta name="keywords" content="websocket, flask, socketio, real-time, programming">
    <meta property="og:title" content="WebSocket ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ãƒ†ã‚¹ãƒˆ">
    <meta property="og:image" content="https://kakaomames.github.io/rei/logo.png">
    <meta property="og:url" content="https://kakaomame.github.io/">
    <title>WebSocket æ¥ç¶šãƒ†ã‚¹ãƒˆ - GeminiéšŠ</title>
    
    <style>
        /* ... (CSSã‚¹ã‚¿ã‚¤ãƒ«ã¯å‰å›ã¨åŒã˜) ... */
        body { font-family: sans-serif; margin: 20px; }
        #log-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 350px;
            max-height: 80vh;
            background-color: #2c3e50; /* ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ«ãƒ¼ */
            color: #ecf0f1; /* ç™½ã£ã½ã„æ–‡å­— */
            border-top-left-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 10px;
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
            overflow: hidden;
            flex-direction: column;
        }
        #log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 5px;
            border-bottom: 1px solid #34495e;
            cursor: pointer;
        }
        #log-output {
            overflow-y: auto;
            flex-grow: 1;
            padding-top: 5px;
            list-style: none;
            padding-left: 0;
            margin: 0;
            font-size: 0.8em;
            word-wrap: break-word;
        }
        #log-output li {
            margin-bottom: 2px;
            border-bottom: 1px dotted #34495e;
            padding-bottom: 2px;
        }
        .status-badge {
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .status-green { background-color: #27ae60; color: white; }
        .status-red { background-color: #c0392b; color: white; }
        .status-orange { background-color: #f39c12; color: white; }
        
        button {
            padding: 8px 15px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        #message-input {
            padding: 10px;
            width: 300px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #log-footer {
            margin-top: 10px;
            text-align: right;
        }
    </style>
</head>
<body>
    <h1>éšŠå“¡WebSocketæ¥ç¶šãƒ†ã‚¹ãƒˆ</h1>
    <p>ã‚µãƒ¼ãƒãƒ¼URL: <strong id="server-url-display"></strong></p>
    <hr>
    
    <h2>æ¥ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="status" class="status-badge status-red">åˆ‡æ–­ä¸­</span></h2>
    <p id="retry-info" style="font-size: 0.9em;"></p>
    
    <hr>
    
    <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</h2>
    <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
    <button onclick="sendMessage()">é€ä¿¡</button>
    
    <hr>
    
    <button onclick="toggleLogBox()">ãƒ­ã‚°è¡¨ç¤º/éè¡¨ç¤º</button>

    <div id="log-container">
        <div id="log-header" onclick="toggleLogBox()">
            <strong>ğŸš¨ [Log Box] ç¨¼åƒä¸­ï¼ (ã‚¯ãƒªãƒƒã‚¯ã§éè¡¨ç¤º)</strong>
        </div>
        <ul id="log-output">
            <li>[LOG] --- ãƒ­ã‚°é–‹å§‹ ---</li>
        </ul>
        <div id="log-footer">
            <button onclick="copyLog()">ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    
    <script>
        // è¨­å®šå€¤
        // ğŸš¨ éšŠå“¡ã®Render URLã‚’è¨­å®š
        const RENDER_WS_URL = 'https://pokekueapk.onrender.com'; 
        const MAX_RETRY_COUNT = 15;
        const BASE_RETRY_DELAY_MS = 1000;

        let socket = null;
        let retryCount = 0;
        
        document.getElementById('server-url-display').textContent = RENDER_WS_URL;

        // ... (toggleLogBox, copyLog, calculateNextDelay, attemptReconnect, sendMessage, updateStatus, logMessage é–¢æ•°ã¯å‰å›ã¨åŒã˜) ...
        function toggleLogBox() {
            const logBox = document.getElementById('log-container');
            if (logBox.style.display === 'flex') {
                logBox.style.display = 'none';
            } else {
                logBox.style.display = 'flex';
            }
        }
        
        function copyLog() {
            const logItems = document.getElementById('log-output').getElementsByTagName('li');
            let logText = `--- LOG COPY (${new Date().toLocaleString()}) ---\n`;
            for (let i = 0; i < logItems.length; i++) {
                logText += logItems[i].textContent + '\n';
            }

            navigator.clipboard.writeText(logText).then(() => {
                alert('ãƒ­ã‚°ãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼');
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
                alert('ãƒ­ã‚°ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }

        function calculateNextDelay() {
            const delay = Math.min(BASE_RETRY_DELAY_MS * Math.pow(2, retryCount), 30000); 
            return delay;
        }

        function attemptReconnect() {
            if (retryCount >= MAX_RETRY_COUNT) {
                updateStatus('å†æ¥ç¶šå¤±æ•— (ä¸Šé™ã«é”ã—ã¾ã—ãŸ)', 'darkred');
                logMessage('ğŸ›‘ å†æ¥ç¶šè©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚', 'error');
                return;
            }

            const delay = calculateNextDelay();
            retryCount++;
            
            logMessage(`[LOG] ... ${delay / 1000}ç§’å¾Œã«å†æ¥ç¶š (${retryCount}/${MAX_RETRY_COUNT})ã‚’è©¦ã¿ã¾ã™`, 'system');

            setTimeout(() => {
                connectSocket();
            }, delay);
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value;
            
            if (socket && socket.connected) {
                socket.emit('client_message', { data: message });
                logMessage(`[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé€ä¿¡] ${message}`, 'client');
                input.value = '';
            } else {
                logMessage('âš ï¸ æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'warning');
            }
        }
        
        function updateStatus(text, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = text;
            statusElement.className = 'status-badge';
            if (type === 'green') statusElement.classList.add('status-green');
            if (type === 'red') statusElement.classList.add('status-red');
            if (type === 'orange') statusElement.classList.add('status-orange');
            if (type === 'darkred') statusElement.style.backgroundColor = 'darkred';
            if (type === 'darkred') statusElement.style.color = 'white';
        }

        function logMessage(message, type) {
            const messages = document.getElementById('log-output');
            const listItem = document.createElement('li');
            listItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            if (type === 'system') listItem.style.color = '#7f8c8d'; 
            if (type === 'success') listItem.style.color = '#27ae60';
            if (type === 'server') listItem.style.color = '#3498db';
            if (type === 'client') listItem.style.color = '#f39c12';
            if (type === 'error') listItem.style.color = '#c0392b';
            if (type === 'warning') listItem.style.color = '#e67e22';
            
            messages.appendChild(listItem);
            messages.scrollTop = messages.scrollHeight; 
        }

        // --- æ–°è¦è¿½åŠ : HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚‹ã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ ---
        async function checkHttpConnection(url) {
            try {
                // Fetch APIã‚’ä½¿ã£ã¦Render URLã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
                const response = await fetch(url);
                const status = response.status;
                const statusText = response.statusText;
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã¯æœ€å¤§100æ–‡å­—ã ã‘å–å¾—
                const text = await response.text();
                const bodyPreview = text.substring(0, 100).replace(/\n/g, '\\n') + (text.length > 100 ? '...' : '');

                logMessage(`[HTTPãƒã‚§ãƒƒã‚¯] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${status} ${statusText}`, status === 200 ? 'success' : 'warning');
                logMessage(`[HTTPãƒã‚§ãƒƒã‚¯] ãƒœãƒ‡ã‚£ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: "${bodyPreview}"`, 'system');

                if (status === 200) {
                    logMessage(`[HTTPãƒã‚§ãƒƒã‚¯] ã‚µãƒ¼ãƒãƒ¼ã¯ç¨¼åƒä¸­ã¨åˆ¤æ–­ã•ã‚Œã¾ã™ã€‚`, 'success');
                } else {
                    logMessage(`[HTTPãƒã‚§ãƒƒã‚¯] è­¦å‘Š: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ ${status} ã§ã™ã€‚ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`, 'error');
                }
                return status;

            } catch (error) {
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€CORSãƒ–ãƒ­ãƒƒã‚¯ã€ã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ã‚­ãƒ£ãƒƒãƒã•ã‚Œã¾ã™ã€‚
                logMessage(`ğŸš¨ [HTTPãƒã‚§ãƒƒã‚¯ ERROR] æ¥ç¶šå¤±æ•—ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/CORS/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰: ${error.message}`, 'error');
                // éšŠå“¡ã®ãƒ­ã‚°ã«åˆã‚ã›ã€ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å‡ºåŠ›
                logMessage(`ğŸš¨ [HTTPãƒã‚§ãƒƒã‚¯ ERROR] è©³ç´°: ${JSON.stringify(error, Object.getOwnPropertyNames(error))}`, 'error');
                return 0; // å¤±æ•—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã—ã¦0ã‚’è¿”ã™
            }
        }
        // -----------------------------------------------------------


        // æ¥ç¶šå‡¦ç†ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        async function connectSocket() { // asyncã«å¤‰æ›´
            // å‰ã®æ¥ç¶šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if (socket && socket.connected) {
                socket.disconnect();
            }

            const delay = calculateNextDelay();
            updateStatus('æ¥ç¶šä¸­...', 'orange');
            document.getElementById('retry-info').textContent = `è©¦è¡Œå›æ•°: ${retryCount} / ${MAX_RETRY_COUNT}ã€‚${retryCount > 0 ? ` æ¬¡ã®æ¥ç¶šã¾ã§ ${delay / 1000}ç§’...` : ''}`;
            logMessage(`[LOG] æ¥ç¶šè©¦è¡Œé–‹å§‹... (URL: ${RENDER_WS_URL})`, 'system');
            
            // WSæ¥ç¶šè©¦è¡Œã®å‰ã«ã€é€šå¸¸ã®HTTPãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
            await checkHttpConnection(RENDER_WS_URL);
            
            // æ¥ç¶š
            socket = io(RENDER_WS_URL, {
                transports: ['websocket'], 
                reconnection: false
            });

            // ... (ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã¯å‰å›ã¨åŒã˜) ...
            socket.on('connect', () => {
                logMessage('ğŸŸ¢ ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸï¼', 'success');
                updateStatus('æ¥ç¶šæ¸ˆã¿', 'green');
                retryCount = 0;
                document.getElementById('retry-info').textContent = 'æ¥ç¶šã¯å®‰å®šã—ã¦ã„ã¾ã™ã€‚';
            });

            socket.on('disconnect', (reason) => {
                logMessage(`ğŸ”´ æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚ç†ç”±: ${reason}`, 'error');
                updateStatus('åˆ‡æ–­ä¸­ (å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™)', 'red');
                attemptReconnect();
            });
            
            socket.on('server_response', (data) => {
                logMessage(`[ã‚µãƒ¼ãƒãƒ¼] ${data.data}`, 'server');
            });
            
            socket.on('connect_error', (error) => {
                logMessage(`ğŸš¨ [ERROR] æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${JSON.stringify(error, Object.getOwnPropertyNames(error))}`, 'error');
            });
        }
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æ¥ç¶šé–‹å§‹ã¨ãƒ­ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º
        document.addEventListener('DOMContentLoaded', () => {
            connectSocket();
            toggleLogBox(); // åˆæœŸè¡¨ç¤º
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gemini programmingéšŠ - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ WebSocketã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ">
    <meta name="keywords" content="websocket, flask, socketio, real-time, programming">
    <meta property="og:title" content="WebSocket ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ãƒ†ã‚¹ãƒˆ">
    <meta property="og:image" content="https://kakaomames.github.io/rei/logo.png">
    <meta property="og:url" content="https://kakaomame.github.io/">
    <title>WebSocket æ¥ç¶šãƒ†ã‚¹ãƒˆ - GeminiéšŠ</title>
</head>
<body>
    <h1>éšŠå“¡WebSocketæ¥ç¶šãƒ†ã‚¹ãƒˆ</h1>
    <p>ã‚µãƒ¼ãƒãƒ¼URL: <strong id="server-url-display"></strong></p>
    <hr>
    
    <h2>æ¥ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="status" style="color: red;">åˆ‡æ–­ä¸­</span></h2>
    <p id="retry-info" style="font-size: 0.9em;"></p>
    
    <hr>
    
    <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</h2>
    <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
    <button onclick="sendMessage()">é€ä¿¡</button>
    
    <hr>
    
    <h2>ãƒ­ã‚°</h2>
    <ul id="messages"></ul>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    
    <script>
        // è¨­å®šå€¤
        const RENDER_WS_URL = 'https://pokekueapk.onrender.com'; // âš ï¸ ã“ã“ã«å®Ÿéš›ã®Render URLã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼
        const MAX_RETRY_COUNT = 10;
        const BASE_RETRY_DELAY_MS = 2000; // 2ç§’

        let socket = null;
        let retryCount = 0;
        
        // ç”»é¢ã«ã‚µãƒ¼ãƒãƒ¼URLã‚’è¡¨ç¤º
        document.getElementById('server-url-display').textContent = RENDER_WS_URL;

        // æ¥ç¶šå‡¦ç†ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        function connectSocket() {
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
            updateStatus('æ¥ç¶šä¸­...', 'orange');
            
            // æ¥ç¶šè©¦è¡Œå›æ•°ã¨æ¬¡ã®å†æ¥ç¶šã¾ã§ã®æ™‚é–“ã‚’è¡¨ç¤º
            const delay = calculateNextDelay();
            document.getElementById('retry-info').textContent = `è©¦è¡Œå›æ•°: ${retryCount} / ${MAX_RETRY_COUNT}ã€‚${retryCount > 0 ? ` æ¬¡ã®æ¥ç¶šã¾ã§ ${delay / 1000}ç§’...` : ''}`;


            // æ¥ç¶š
            // ã‚µãƒ¼ãƒãƒ¼å´ãŒ HTTPS ã§å‹•ã„ã¦ã„ã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚‚ 'https' ã‚’æŒ‡å®š
            socket = io(RENDER_WS_URL, {
                transports: ['websocket', 'polling'], // ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
                reconnection: false // è‡ªå‹•å†æ¥ç¶šã¯è‡ªå‰ã§åˆ¶å¾¡
            });

            // æ¥ç¶šæˆåŠŸæ™‚
            socket.on('connect', () => {
                console.log('a:WebSocketæ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸï¼');
                updateStatus('æ¥ç¶šæ¸ˆã¿', 'green');
                logMessage('ğŸŸ¢ ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸï¼', 'system');
                retryCount = 0; // æˆåŠŸã—ãŸã®ã§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('retry-info').textContent = '';
            });

            // åˆ‡æ–­æ™‚
            socket.on('disconnect', (reason) => {
                console.log(`a:WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚ç†ç”±: ${reason}`);
                logMessage(`ğŸ”´ æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚ç†ç”±: ${reason}`, 'system');
                updateStatus('åˆ‡æ–­ä¸­ (å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™)', 'red');
                
                // å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
                attemptReconnect();
            });
            
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã€Œserver_responseã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡æ™‚
            socket.on('server_response', (data) => {
                console.log('a:ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡:', data);
                logMessage(`[ã‚µãƒ¼ãƒãƒ¼] ${data.data}`, 'server');
            });
            
            // æ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ï¼ˆãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯å¤±æ•—ãªã©ï¼‰
            socket.on('connect_error', (error) => {
                console.error('a:æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                logMessage(`âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'system');
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€disconnectã‚¤ãƒ™ãƒ³ãƒˆãŒç¶šã„ã¦ç™ºç«ã™ã‚‹ãŸã‚ã€ãã¡ã‚‰ã§å†æ¥ç¶šå‡¦ç†ã‚’è¡Œã†
            });
        }
        
        // æŒ‡æ•°é–¢æ•°çš„ãƒãƒƒã‚¯ã‚ªãƒ•ã«ã‚ˆã‚‹å¾…ã¡æ™‚é–“ã®è¨ˆç®—
        function calculateNextDelay() {
            // delay = 2^retryCount * BASE_RETRY_DELAY_MSã€‚ãŸã ã—ã€æœ€å¤§é…å»¶æ™‚é–“ã‚’è¨­å®š
            const delay = Math.min(BASE_RETRY_DELAY_MS * Math.pow(2, retryCount), 30000); // æœ€å¤§30ç§’
            return delay;
        }

        // å†æ¥ç¶šã‚’è©¦ã¿ã‚‹é–¢æ•°ï¼ˆæŒ‡æ•°é–¢æ•°çš„ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ãï¼‰
        function attemptReconnect() {
            if (retryCount >= MAX_RETRY_COUNT) {
                updateStatus('å†æ¥ç¶šå¤±æ•— (ä¸Šé™ã«é”ã—ã¾ã—ãŸ)', 'darkred');
                logMessage('ğŸ›‘ å†æ¥ç¶šè©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚', 'system');
                return;
            }

            const delay = calculateNextDelay();
            retryCount++;
            
            logMessage(`... ${delay / 1000}ç§’å¾Œã«å†æ¥ç¶š (${retryCount}/${MAX_RETRY_COUNT})ã‚’è©¦ã¿ã¾ã™`, 'system');

            setTimeout(() => {
                connectSocket();
            }, delay);
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value;
            
            if (socket && socket.connected) {
                // Flaskã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒ³ãƒ‰ãƒ©åã«åˆã‚ã›ã¦ 'client_message' ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã¾ã™
                socket.emit('client_message', { data: message });
                logMessage(`[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé€ä¿¡] ${message}`, 'client');
                input.value = '';
            } else {
                logMessage('âš ï¸ æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'system');
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function updateStatus(text, color) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = text;
            statusElement.style.color = color;
        }

        // ãƒ­ã‚°ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function logMessage(message, type) {
            const messages = document.getElementById('messages');
            const listItem = document.createElement('li');
            listItem.textContent = message;
            
            // ãƒ­ã‚°ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è‰²ã‚’ä»˜ã‘ã‚‹ï¼ˆè¦–èªæ€§å‘ä¸Šï¼‰
            if (type === 'system') listItem.style.color = '#1f77b4'; // é’
            if (type === 'server') listItem.style.color = '#2ca02c'; // ç·‘
            if (type === 'client') listItem.style.color = '#ff7f0e'; // ã‚ªãƒ¬ãƒ³ã‚¸
            
            messages.appendChild(listItem);
            messages.scrollTop = messages.scrollHeight; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã¸
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æ¥ç¶šé–‹å§‹
        connectSocket();
    </script>
</body>
</html>
